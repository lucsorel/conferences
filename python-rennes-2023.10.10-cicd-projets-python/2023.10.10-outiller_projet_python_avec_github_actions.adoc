:revealjs_customtheme: assets/beige-stylesheet.css
:revealjs_progress: true
:revealjs_slideNumber: true
:source-highlighter: highlightjs
:icons: font
:toc:

= Outiller son projet open-source Python avec les Github actions

== Qui suis-je ?

* ğŸ’™ğŸ’› dev Python @ https://www.purecontrol.com[Purecontrol]
* ğŸˆâ€â¬› https://github.com/lucsorel[github.com/lucsorel] (outils code-to-doc)
* ğŸ˜ https://floss.social/@lucsorelgiffo[@lucsorelgiffo@floss.social]

== Le projet open-source Python

https://github.com/lucsorel/py2puml : gÃ©nÃ¨re un diagramme de classes en scannant les structures de donnÃ©es de la base de code.

image::http://www.plantuml.com/plantuml/svg/ZL9HQzim47xNhxYz5kh07aqVMaBO36jIiknfb72sBvcO97lIUH3Q_lUT7TMCEaH-qeTqztsVxhxxmEYvimRQq-TMpgnkB6gdFhKUZnQX2rGu9c-friZqXDLlF5A00vf0gZ8OmeVMh3tNPB4MNXI0Gqiv1FQ2gr_Qr9vS3jzqu9-nx5bUD9CDUzVPadmEsh5wkomXSBZFVbZpmEnrsV5KY4_jY0CZwog7icdC7DPb3mP6VESFqV3_ceFhiCTILB3Y97__mvw-a7FYz_373V1AFybmiaVg1pHf_ukcera4Oc0bvy1W1xBtlvsfduMWBxpGxyaWwyPbMp8xcU_0iTmyFcs-5xjYiyxX1bxEmtwJbsBzTRKjTW_hvIg7kzVnQUfmgY0kjn4FAg7fV4NxSKe0ZFv8FDwCAu_UH2GHpPlRsqHwLIeZaICTJvL8mzsh4ANKL6AZOkPwQkQwk2AYvkqiUaa5I1sQXid35tBaaQc6yWIBHMnSBDGzkLhGFm00[py2puml,width="45%"]

[.columns]
=== SyndrÃ´me de Spiderman

[.column]
--
**Spiderman**

* 1 piqÃ»re : ğŸ˜¬
* grimpe aux murs : ğŸ’ª
* anime des soirÃ©es mousse avec les poignets : ğŸ¥³

image::assets/spiderman_got_it_wrong.png[]
--

[.column]
--
--

[.columns]
=== SyndrÃ´me de Spiderman

[.column]
--
**Spiderman**

* 1 piqÃ»re : ğŸ˜¬
* grimpe aux murs : ğŸ’ª
* anime des soirÃ©es mousse avec les poignets : ğŸ¥³

image::assets/spiderman_got_it_wrong.png[]
--

[.column]
--
**py2puml**

* 140+ â­ : ğŸ¥³
* 37 issues (24 fermÃ©es) : ğŸ˜¬
* 25 PR (21 fermÃ©es) : ğŸ¥µ

[.medium-text]
____
> **"De nouvelles responsabilitÃ©s demandent de nouveaux pouvoirs."**
>
> Luc (du 35) ğŸ•¸ï¸
____
--

=== Accueillir et cadrer les contributions

[%step]
* non-rÃ©gression des fonctionnalitÃ©s
* homogÃ©nÃ©itÃ© des pratiques
** formatage de code
** qualitÃ© de code

=== ğŸ’¡ CONTRIBUTING.md dans le dÃ©pÃ´t ?

ğŸ—£ï¸ "bla bla bla" -> âŒ

Des conventions non outillÃ©es finissent dans l'oubli.

=== ğŸ’¡ IntÃ©gration continue

* non-rÃ©gression -> **tests automatisÃ©s** (+ couverture de code testÃ©)
* homogÃ©nÃ©itÃ© de la base de code
** formatage de code -> **formateur**
** qualitÃ© de code -> **linter**

== Mise en place des Github actions

Syntaxe **dÃ©clarative** permettant d'exÃ©cuter des commandes ou des outils au fil du cycle de vie _git_ du projet.

[source,text]
----
super-projet/
  â”œâ”€ .github/
  â”‚  â””â”€ workflows/
  â”‚     â”œâ”€ {nom_de_workflow}.yml  # ci.yml, par exemple
  â”‚     â””â”€ ...
----

image::assets/mark_yaml.jpg[width="50%"]

=== Anatomie progressive d'un workflow d'intÃ©gration continue Github

DÃ©part : systÃ¨me d'exploitation + checkout du code source

[source,yaml]
----
name: Python CI # facultatif

on: push        # Ã©vÃ¨nement(s) git dÃ©clencheur(s)

jobs:
  build:                   # le nom de l'opÃ©ration
    runs-on: ubuntu-latest     # systÃ¨me d'exploitation utilisÃ©
    steps:                     # Ã©tapes de l'opÃ©ration
      - name: RÃ©cupÃ©ration du code # facultatif
        uses: actions/checkout@v4  # utilisation d'une recette existante (âš ï¸ @version)
----

[.medium-text]
--
Documentation officielle des https://docs.github.com/en/actions/learn-github-actions/understanding-github-actions[Github actions].
--

=== Actions : les recettes de base

[%step]
* action = brique rÃ©utilisable et adaptable Ã  votre besoin
** chacune a son dÃ©pÃ´t
** configuration dÃ©crite dans `action.yaml`
** parfois accompagnÃ©e de scripts rÃ©fÃ©rencÃ©s dans `action.yaml`
* 62 actions "officielles" proposÃ©es par Github (septembre 2023)
* nombreuses actions communautaires

[.medium-text]
Exemples : https://github.com/actions/checkout[github.com/actions/checkout], https://github.com/abatilo/actions-poetry[github.com/abatilo/actions-poetry]

=== Ã‰tapes de build du projet

[%step]
. rÃ©cupÃ©rer les sources du projet âœ…
. installer `python`
. installer `poetry`
. installer les dÃ©pendances
. lancer les tests automatisÃ©s + couverture
. auditer la qualitÃ© du code

== Installation de Python - pyenv

Projet utilisant https://github.com/pyenv/pyenv/[pyenv] pour dÃ©finir la version de `python`.

[source,yaml]
----
name: Python CI
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Installation de Python
        uses: actions/setup-python@v4            # action officielle
        with:                                    # configuration pour pyenv
          python-version-file: '.python-version' # mÃ j transparente de l'IC ğŸ‘
----

=== Installation de Python - alternatives

Configuration alternatives de l'action :

[source,yaml]
----
steps:
  # derniÃ¨re version disponible (âš ï¸ varie en fonction du runner)
  - uses: actions/setup-python@v4

  # version spÃ©cifiÃ©e en dur ğŸ¤·
  - uses: actions/setup-python@v4
    with:
      python-version: '3.9'

  # utilisation de PyPy
  - uses: actions/setup-python@v4 
    with:
      python-version: 'pypy3.9' 
----

[.medium-text]
Voir d'https://github.com/actions/setup-python/blob/main/docs/advanced-usage.md[autres cas d'usage avancÃ©s] (intervalle ou matrice de versions, caches pour outils spÃ©cifiques, etc.).

=== Installation des dÃ©pendances - poetry

- utilisation de https://python-poetry.org/docs/[poetry] pour la gestion des dÃ©pendances
- dossier `.venv/` local (Ã  mettre en cache ğŸ’¡)

[source,yaml]
----
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # [...]
      - name: Installation de poetry
        uses: abatilo/actions-poetry@v2 # action communautaire ğŸ”
        with:
          poetry-version: 1.5.1         # optionnel

      - name: Mise en cache de l'environnement virtuel
        uses: actions/cache@v3          # action officielle
        with:
          path: ./.venv
          key: venv-${{ hashFiles('poetry.lock') }} # clÃ© d'Ã©viction sur le lock-file

      - name: Installation des dÃ©pendances du projet
        run: poetry install             # exÃ©cution explicite d'une commande ğŸ”
----

=== Installation des dÃ©pendances - requirements.txt

Alternative avec `pip` + `requirements.txt` directement ğŸ™… :

[source,yaml]
----
steps:
  - uses: actions/setup-python@v4
    with:
      python-version: '3.9'
      cache: 'pip' # utilisation d'un cache pour pip

    - run: pip install -r requirements.txt # pas besoin d'environnement virtuel
                                           # au sein d'un runner
----

=== ExÃ©cution des tests

[source,yaml]
----
env:
  MIN_CODE_COVERAGE_PERCENT: 93 # ğŸ‘‰ dÃ©finition d'une variable

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # [...]
      - name: Lancement des tests automatisÃ©s (avec couverture de code)
        run: > # '>' permet de sÃ©parer une commande sur plusieurs lignes
          poetry run pytest -v --cov=py2puml --cov-branch
          --cov-report term-missing
          --cov-fail-under $MIN_CODE_COVERAGE_PERCENT # utilisation ğŸ‘ˆ
          # l'opÃ©ration sera en Ã©chec si le taux de couverture descend sous le seuil
----

=== Consultation des exÃ©cutions de workflow dans Github

. cliquer sur le menu `Actions` de votre dÃ©pÃ´t sur Github
. cliquer sur une des exÃ©cutions de workflow

image::assets/github_actions_run.png[width="75%"]

=== DÃ©mo !

image::assets/demo.gif[]

== Et les hooks de pre-commit ?

L'outil https://pre-commit.com/[pre-commit] utilise les mÃ©canismes de hook de `git` pour lancer des outils Ã  diffÃ©rentes Ã©tapes du cycle de vie `git` du projet.

.Rediffusion : https://www.youtube.com/watch?v=l0HrTE45RVM
image::assets/hook_il_est_beau_notre_code-breizhcamp_2023.png[width="30%",link="https://www.youtube.com/watch?v=l0HrTE45RVM"]

== Exemple de configuration pre-commit (ğŸ“„ .pre-commit-config.yaml)

[source,yaml]
----
repos:
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
    -   id: trailing-whitespace
    -   id: end-of-file-fixer
    -   id: double-quote-string-fixer

-   repo: https://github.com/google/yapf
    rev: v0.40.2
    hooks:
    -   id: yapf
        additional_dependencies: [toml]

-   repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.0.292
    hooks:
    -   id: ruff
----

[.medium-text]
Voir https://pre-commit.com/hooks.html[pre-commit.com/hooks.html].

=== Utiliser pre-commit en intÃ©gration continue

__Ã€ la dure__ dans le runner Github d'intÃ©gration continue

** installer git 
** lancer pre-commit

Ou via une intÃ©gration avec le service https://pre-commit.ci/[pre-commit.ci]

=== IntÃ©grer pre-commit.ci dans son projet Github 1/5

. aller sur https://pre-commit.ci/
. s'identifier avec Github

image::assets/01-sign-in_with_github.png[]

=== IntÃ©grer pre-commit.ci dans son projet Github 2/5

- ajouter une installation

image::assets/02-add_an_installation.png[]

[.columns]
=== IntÃ©grer pre-commit.ci dans son projet Github 3/5

[.column]
--
- configurer l'intÃ©gration

image::assets/03-select_github_account_in_which_pre-commit-ci_will_be_installed.png[]
--

[.column]
--
- confirmer l'accÃ¨s au compte

image::assets/04-confirm_github_access.png[]
--
=== IntÃ©grer pre-commit.ci dans son projet Github 4/5

- sÃ©lectionner le dÃ©pÃ´t de code Ã  intÃ©grer

image::assets/05-select_repository.png[width="55%"]

=== IntÃ©grer pre-commit.ci dans son projet Github 5/5

â˜ï¸ Ne se dÃ©clenche que dans le cadre d'une pull-request.

image::assets/06-pre-commit_results.png[width="65%"]

== Prochaines Ã©tapes

[plantuml, target=sequence-diagram, format=svg]
----
@startuml ci-semantic-release-publish
skinparam handwritten true

participant "branche de dev" as feature
feature -> feature : workflow de build
note right
  vulnÃ©rabilitÃ©s des dÃ©pendances (""pip-audit"")

  ""pre-commit"" :
  - format de message de commit (**commitlint**)
    (refactor, fix, feat, etc.)
  - formatage, lint, etc.

  tests automatisÃ©s
end note

feature -> main : fusion PR
main -> main : workflow de release
note right
  montÃ©e de version (**python-semantic-release**)
  - messages de commits -> nouvelle version ""$NEW_VERSION = maj.min.patch""
  - mÃ j ""pyproject.toml"", ""~__version~__.py"", etc.
  - ""git commit -m "[skip ci] $NEW_VERSION""" (Ã©vite de boucler sur le workflow)
  - poussÃ©e du nouveau tag (Ã§a n'est pas un commit)

  publication
  - ""poetry ~--build publish ~--repository ...""
    (le numÃ©ro de version dans pyproject.toml est utilisÃ© pour le numÃ©ro de version)
end note

main -> PyPI : publication ""$NEW_VERSION""
@enduml
----

[.medium-text]
--
Voir : https://github.com/pypa/pip-audit[pip-audit], utiliser https://docs.github.com/en/actions/managing-workflow-runs/skipping-workflow-runs[skip ci],  hook https://github.com/alessandrojcm/commitlint-pre-commit-hook[commitlint], outil https://python-semantic-release.readthedocs.io/en/latest/index.html[Python Semantic Release]
--

[.columns]
== Les Github actions !

[.column]
--
image::assets/code_ci_ci_yo.webp[]
--

[.column]
--
* systÃ¨me gratuit de CI / CD
* YAML dÃ©claratif
* originalitÃ© des actions : briques composables
* s'adapte Ã  une diversitÃ© de projets
--

=== Merci !

ğŸ’¬ ğŸ—¨ï¸

Des questions ?

[.medium-text]
PrÃ©sentation Ã  retrouver sur https://github.com/lucsorel/conferences/tree/main/python-rennes-2023.10.10-cicd-projets-python[github.com/lucsorel/conferences/tree/main/python-rennes-2023.10.10-cicd-projets-python] ğŸ“‘
