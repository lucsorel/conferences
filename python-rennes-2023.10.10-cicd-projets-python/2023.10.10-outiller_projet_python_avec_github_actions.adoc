:revealjs_customtheme: assets/beige-stylesheet.css
:revealjs_progress: true
:revealjs_slideNumber: true
:source-highlighter: highlightjs
:icons: font
:toc:

= Outiller son projet open-source Python avec les Github actions

== Qui suis-je ?

* üíôüíõ dev Python @ PureControl
* üêà‚Äç‚¨õ https://github.com/lucsorel[github.com/lucsorel] (doc-as-code, doc-from-code)
* üêò https://floss.social/@lucsorelgiffo[@lucsorelgiffo@floss.social]

== Le projet open-source Python

https://github.com/lucsorel/py2puml : g√©n√®re un diagramme de classes en scannant les structures de donn√©es de la base de code.

image::http://www.plantuml.com/plantuml/svg/ZL9HQzim47xNhxYz5kh07aqVMaBO36jIiknfb72sBvcO97lIUH3Q_lUT7TMCEaH-qeTqztsVxhxxmEYvimRQq-TMpgnkB6gdFhKUZnQX2rGu9c-friZqXDLlF5A00vf0gZ8OmeVMh3tNPB4MNXI0Gqiv1FQ2gr_Qr9vS3jzqu9-nx5bUD9CDUzVPadmEsh5wkomXSBZFVbZpmEnrsV5KY4_jY0CZwog7icdC7DPb3mP6VESFqV3_ceFhiCTILB3Y97__mvw-a7FYz_373V1AFybmiaVg1pHf_ukcera4Oc0bvy1W1xBtlvsfduMWBxpGxyaWwyPbMp8xcU_0iTmyFcs-5xjYiyxX1bxEmtwJbsBzTRKjTW_hvIg7kzVnQUfmgY0kjn4FAg7fV4NxSKe0ZFv8FDwCAu_UH2GHpPlRsqHwLIeZaICTJvL8mzsh4ANKL6AZOkPwQkQwk2AYvkqiUaa5I1sQXid35tBaaQc6yWIBHMnSBDGzkLhGFm00[py2puml,width="45%"]

[.columns]
=== Syndr√¥me de Spiderman

[.column]
--
**Spiderman**

* 1 piq√ªre : üò¨
* grimpe aux murs : üí™
* anime des soir√©es mousse avec les poignets : ü•≥

image::assets/spiderman_got_it_wrong.png[]
--

[.column]
--
--

[.columns]
=== Syndr√¥me de Spiderman

[.column]
--
**Spiderman**

* 1 piq√ªre : üò¨
* grimpe aux murs : üí™
* anime des soir√©es mousse avec les poignets : ü•≥

image::assets/spiderman_got_it_wrong.png[]
--

[.column]
--
**py2puml**

* 140+ ‚≠ê : ü•≥
* 37 issues (24 ferm√©es) : üò¨
* 25 PR (21 ferm√©es) : ü•µ

[.medium-text]
____
> **"De nouvelles responsabilit√©s demandent de nouveaux pouvoirs."**
>
> Luc (du 35) üï∏Ô∏è
____
--

=== Accueillir et cadrer les contributions

* non-r√©gression des fonctionnalit√©s
* homog√©n√©it√© des pratiques
** formatage de code
** qualit√© de code

=== CONTRIBUTING.md dans le d√©p√¥t ?

üó£Ô∏è "bla bla bla" -> ‚ùå

Des conventions non outill√©es finissent dans l'oubli.

=== Int√©gration continue

* non-r√©gression -> **tests automatis√©s** (+ couverture de code test√©)
* homog√©n√©it√© de la base de code
** formatage de code -> **formateur**
** qualit√© de code -> **linter**

== Mise en place des Github actions

Syntaxe **d√©clarative** permettant d'ex√©cuter des commandes ou des outils au fil du cycle de vie _git_ du projet.

[source,text]
----
super-projet/
  ‚îú‚îÄ .github/
  ‚îÇ  ‚îî‚îÄ workflows/
  ‚îÇ     ‚îú‚îÄ {nom_de_workflow}.yml  # ci.yml, par exemple
  ‚îÇ     ‚îî‚îÄ ...
----

image::assets/mark_yaml.jpg[width="50%"]

=== Anatomie progressive d'un workflow d'int√©gration continue Github

D√©part : syst√®me d'exploitation + checkout du code source

[source,yaml]
----
name: Python CI # facultatif

on: push        # √©v√®nement(s) git d√©clencheur(s)

jobs:
  build:                   # le nom de l'op√©ration
    runs-on: ubuntu-latest     # syst√®me d'exploitation utilis√©
    steps:                     # √©tapes de l'op√©ration
      - name: R√©cup√©ration du code # facultatif
        uses: actions/checkout@v4  # utilisation d'une recette existante (‚ö†Ô∏è @version)
----

=== Actions : les recettes de base

* action = brique r√©utilisable et adaptable √† votre besoin
** chacune a son d√©p√¥t
** configuration d√©crite dans `action.yaml`
** parfois accompagn√©e de scripts r√©f√©renc√©s dans `action.yaml`
* 62 actions "officielles" propos√©es par Github (septembre 2023)
* nombreuses actions communautaires

[.medium-text]
Exemples : https://github.com/actions/checkout[github.com/actions/checkout], https://github.com/abatilo/actions-poetry[github.com/abatilo/actions-poetry]

=== Op√©ration de build du projet

[%step]
. r√©cup√©rer les sources du projet ‚úÖ
. installer `python`
. installer `poetry`
. installer les d√©pendances
. lancer les tests automatis√©s + couverture
. (et les hooks de `pre-commit` ‚ÅâÔ∏è)

== Installation de Python - 1/2

Projet utilisant https://github.com/pyenv/pyenv/[pyenv] pour d√©finir la version de `python`.

[source,yaml]
----
name: Python CI
on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v4            # action officielle
        with:                                    # configuration pour pyenv
          python-version-file: '.python-version' # m√†j transparente de l'IC üëç
----

=== Installation de Python - 2/2

Configuration alternatives de l'action :

[source,yaml]
----
steps:
  # derni√®re version disponible (‚ö†Ô∏è varie en fonction du runner)
  - uses: actions/setup-python@v4

  # version sp√©cifi√©e en dur ü§∑
  - uses: actions/setup-python@v4
    with:
      python-version: '3.9'

  # utilisation de PyPy
  - uses: actions/setup-python@v4 
    with:
      python-version: 'pypy3.9' 
----

[.medium-text]
Voir d'https://github.com/actions/setup-python/blob/main/docs/advanced-usage.md[autres cas d'usage avanc√©s] (intervalle ou matrice de versions, caches pour outils sp√©cifiques, etc.).

=== Installation des d√©pendances 1/2

- utilisation de https://python-poetry.org/docs/[poetry] pour la gestion des d√©pendances
- dossier `.venv/` local (√† mettre en cache üí°)

[source,yaml]
----
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # [...]
      - name: Install poetry
        uses: abatilo/actions-poetry@v2 # action communautaire üîç
        with:
          poetry-version: 1.5.1         # optionnel

      - name: Cache the virtual environment
        uses: actions/cache@v3          # action officielle
        with:
          path: ./.venv
          key: venv-${{ hashFiles('poetry.lock') }} # cl√© d'√©viction sur le lock-file

      - name: Install project dependencies
        run: poetry install             # ex√©cution explicite d'une commande üîç
----

=== Installation des d√©pendances 2/2

Alternative avec `pip` + `requirements.txt` directement üôÖ :

[source,yaml]
----
steps:
  - uses: actions/setup-python@v4
    with:
      python-version: '3.9'
      cache: 'pip' # utilisation d'un cache pour pip

    - name: Install project dependencies
      run: pip install -r requirements.txt # pas besoin d'environnement virtuel
                                           # au sein d'un runner
----

=== Ex√©cution des tests

[source,yaml]
----
env:
  MIN_CODE_COVERAGE_PERCENT: 93 # üëâ d√©finition d'une variable

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # [...]
      - name: Run automated tests (with code coverage)
        run: > # '>' permet de s√©parer une commande sur plusieurs lignes
          poetry run pytest -v --cov=py2puml --cov-branch
            --cov-report term-missing
            # l'op√©ration sera en √©chec si le taux de couverture descend sous le seuil
            --cov-fail-under $MIN_CODE_COVERAGE_PERCENT # utilisation üëà
----

=== Consultation des ex√©cutions de workflow dans Github

. cliquer sur le menu `Actions` de votre d√©p√¥t sur Github
. cliquer sur une des ex√©cutions de workflow

image::assets/github_actions_run.png[width="75%"]

== Et les hooks de pre-commit ?

L'outil https://pre-commit.com/[pre-commit] utilise les m√©canismes de hook de git pour lancer des outils √† diff√©rentes √©tapes du cycle de vie git d'un projet.

.Rediffusion : https://www.youtube.com/watch?v=l0HrTE45RVM
image::assets/hook_il_est_beau_notre_code-breizhcamp_2023.png[width="30%",link="https://www.youtube.com/watch?v=l0HrTE45RVM"]

== Exemple de configuration pre-commit (üìÑ .pre-commit-config.yaml)

[source,yaml]
----
repos:
-   repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v3.3.3
    hooks:
    -   id: trailing-whitespace
    -   id: end-of-file-fixer
    -   id: double-quote-string-fixer

-   repo: https://github.com/google/yapf
    rev: v0.40.2
    hooks:
    -   id: yapf
        additional_dependencies: [toml]

-   repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.0.292
    hooks:
    -   id: ruff
----

[.medium-text]
Voir https://pre-commit.com/hooks.html[pre-commit.com/hooks.html].

=== pre-commit en int√©gration continue

* √† la dure dans le runner Github d'int√©gration continue
** installer git 
** lancer pre-commit
* int√©gration avec le service https://pre-commit.ci/[pre-commit.ci]

=== Int√©grer pre-commit.ci dans son projet Github 1/6

. aller sur https://pre-commit.ci/
. s'identifier avec Github

image::assets/01-sign-in_with_github.png[]

=== Int√©grer pre-commit.ci dans son projet Github 2/6

- ajouter une installation

image::assets/02-add_an_installation.png[]

=== Int√©grer pre-commit.ci dans son projet Github 3/6

- configurer l'int√©gration

image::assets/03-select_github_account_in_which_pre-commit-ci_will_be_installed.png[]

=== Int√©grer pre-commit.ci dans son projet Github 4/6

- confirmer l'acc√®s au compte

image::assets/04-confirm_github_access.png[]

=== Int√©grer pre-commit.ci dans son projet Github 5/6

- s√©lectionner le d√©p√¥t de code √† int√©grer

image::assets/05-select_repository.png[width="55%"]

=== Int√©grer pre-commit.ci dans son projet Github 6/6

‚òùÔ∏è Ne se d√©clenche que dans le cadre d'une pull-request.

image::assets/06-pre-commit_results.png[width="65%"]

== √Ä faire

* projet de d√©mo
* conclusion
** syst√®me de CI gratuit
** originalit√© des actions : briques composables
** s'adapte √† une diversit√© de projets
* pour aller plus loin
** calcul du prochain num√©ro de version du projet via les messages de commit
** build et publication de la nouvelle version sur PyPI
