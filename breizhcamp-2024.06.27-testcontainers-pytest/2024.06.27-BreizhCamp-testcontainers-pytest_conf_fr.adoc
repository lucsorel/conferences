:revealjs_customtheme: assets/testcontainers_breizhcamp.css
:revealjs_progress: true
:revealjs_slideNumber: true
:source-highlighter: highlightjs
:icons: font
:toc:

= Testcontainers
 
== Testcontainers

[.splashscreen-title]
****
Tu ne douteras plus de tes fonctionnalit√©s,

jeune Pydawan¬∑e
****

[.medium-text]
*Luc Sorel-Giffo* -- jeudi 27 juin 2024 - 10h30 amphi A -- BreizhCamp (Rennes)

[.columns]
=== Qui suis-je ?

[.column]
--
* tech lead Python chez Purecontrol `#techForGood`

image::assets/purecontrol.png[Interface Purecontrol, 75%]

* (OSS) outils doc-as-code :
** https://github.com/lucsorel/py2puml[py2puml]
** https://github.com/lucsorel/pydoctrace[pydoctrace]
--

[.column]
--

--

[.columns]
=== Qui suis-je ?

[.column]
--
* tech lead Python chez Purecontrol `#techForGood`

image::assets/purecontrol.png[Interface Purecontrol, 75%]

* (OSS) outils doc-as-code :
** https://github.com/lucsorel/py2puml[py2puml]
** https://github.com/lucsorel/pydoctrace[pydoctrace]
--

[.column]
--
* co-animateur Python Rennes

.Meetup : https://www.meetup.com/fr-FR/python-rennes/[www.meetup.com/fr-FR/python-rennes]
image::assets/python_rennes-communaut√©.png[communaut√© Python Rennes, 40%]

.Pour rejoindre le slack : https://join.slack.com/t/pythonrennes/shared_invite/zt-1yd4yioap-lBAngm3Q0jxAKLP6fYJR8w[join.slack.com/t/pythonrennes/shared_invite/zt-1yd4yioap-lBAngm3Q0jxAKLP6fYJR8w]
image::assets/qr_code-slack-Python_Rennes.svg[Rejoindre le slack Python Rennes, 35%]

* https://floss.social/@lucsorelgiffo[@lucsorelgiffo@floss.social]
--

=== Pr√©ambule ‚ö†Ô∏è 

image::assets/attention-diapos-techniques.png[Diapos techniques, 70%]

[.medium-text]
* testcontainers
* pytest : fixtures, markers ; FastAPI : TestClient
* Python : gestionnaire de contexte (with...), g√©n√©rateur (yield...), architecture

[.medium-text]
D√©mos : https://github.com/lucsorel/members-agenda[members-agenda] (planning de b√©n√©voles g√©rant les indisponibilit√©s)

[.notes]
--
https://youtu.be/6TfHqrWejdo?feature=shared&t=46[Star Wars: Return of the Jedi - Rebel Briefing]
--

[.columns]
=== members-agenda

[.column]
--
[plantuml, target=class-diagram, format=svg]
----
@startuml
skinparam linetype polyline
class Slot {
  title: str
  start: datetime
  end: datetime
  venue: Venue
  members: list[Person]
}
class Venue {
  name: str
}
class Event {
  title: str
  start: datetime
  end: datetime
  venue: Venue
  speakers: list[Person]
}
class Person {
  fullname: str
  is_member: bool
}

Slot "*" -up-> "1" Venue : "happens in"
Event "*" -up-> "1" Venue : "happens in"
Slot "*" <-down- "*" Person : "helps in"
Event "*" <-down- "*" Person : "speaks in"

note right of Person
  une personne ne peut pas **intervenir**
  et **√™tre b√©n√©vole** en m√™me temps
end note

@enduml
----
--

[.column]
--
Environnement technique :

* server web : https://fastapi.tiangolo.com/[FastAPI]
* base de donn√©es : MySQL (avec https://pymysql.readthedocs.io/en/latest/index.html[pymysql])
* framework de test : https://docs.pytest.org/en/stable/[pytest]
--


== Pourquoi tester ?

ü§∑ ?

[.notes]
--
* qui travaille sur des projets dans lesquels il y a des tests automatis√©s ?
* qui travaille dans une entreprise dans laquelle il y a un budget d'astreinte ?
--

=== Pourquoi tester ?

[plantuml, target=mindmap-diagram, format=svg]
----
@startmindmap
+[#lightblue] **tester**
++[#lightyellow] pourquoi ?
+++ valider
++++ fonctionnel (cas droits)
++++ robustesse (cas d'erreur)
+++ documenter les IO
++++ entr√©es / sorties de fonctions
++++ artefacts lus ou √©crits (fichiers, bdd, etc.)
@endmindmap
----

=== Quels types de test ?

ü§∑ ?

=== Quels types de test ?

[plantuml, target=mindmap-diagram, format=svg]
----
@startmindmap
+[#lightblue] **tester**
-- pourquoi ?
--- ... valider
--- ... documenter
++[#lightyellow] comment ?
+++ tests unitaires
++++ faciles
++++ rapides
++++ int√©r√™t m√©tier ‚≠ê
+++ tests de composants
+++ tests fonctionnels
++++ difficiles
++++ lents
++++ int√©r√™t m√©tier üåüüåüüåü
+++ (tests de charge)
@endmindmap
----

[.notes]
--
https://www.bitecode.dev/p/testing-with-python-part-5-the-different
--

[.columns]
== Testcontainers

[.column.is-one-fifth]
--
image::assets/testcontainers-logo.png[logo Testcontainers]

[.medium-text]
* multi-clients : python, java, go, etc.
* +50 services (bdd, brokers)

--

[.column]
--
_A framework for providing throwaway, lightweight instances of databases, message brokers, web browsers, or just about anything that can run in a Docker container._

* https://github.com/testcontainers/testcontainers-python[github.com/testcontainers/testcontainers-python]
* 1.4k ‚≠ê, 27 releases (juin 2024)
* open-source (Apache 2.0)
* 112 contributeur¬∑ices
--

=== Principe de fonctionnement

. d√©marrage du container "vide"
. cr√©ation du contexte initial du test
. d√©roul√© du test
. assertions sur l'√©tat final
. arr√™t et suppression du container

=== üß™1 : la "prod"

[source,python]
----
from os import getenv
from fastapi import FastAPI
from pymysql.connections import Connection, DictCursor

def get_connection() -> Connection:
    M_HOST = getenv('MYSQL_HOST')
    M_PORT = int(getenv('MYSQL_PORT'))
    M_USER = getenv('MEMBERS_AGENDA_USER')
    M_PWD = getenv('MEMBERS_AGENDA_PASSWORD')
    M_DB = getenv('MEMBERS_AGENDA_DATABASE')

    return Connection(
        host=M_HOST, port=M_PORT, user=M_USER, password=M_PWD, database=M_DB
    )

app = FastAPI()

@app.get('/venues')
def get_venues() -> list[dict]:
    get_connection() as connection:
        with connection.cursor(DictCursor) as cursor:
            cursor.execute('SELECT * FROM venues;')
            return cursor.fetchall()
        # -> cl√¥ture du curseur
    # -> cl√¥ture de la connexion
----

=== üß™1 : le test

[source,python]
----
from os import environ
from fastapi.testclient import TestClient
from testcontainers.mysql import MySqlContainer

from members_agenda_api.__main__ import app, get_connection

def test_get_venues():
    with MySqlContainer() as container:
        environ["MYSQL_HOST"] = container.get_container_host_ip()
        environ["MYSQL_PORT"] = container.get_exposed_port(3306)
        environ["MEMBERS_AGENDA_USER"] = container.username
        environ["MEMBERS_AGENDA_PASSWORD"] = container.password
        environ["MEMBERS_AGENDA_DATABASE"] = container.dbname

        create_2_test_venues(get_connection())

        client = TestClient(app)
        response = client.get('/venues')

        assert response.status_code == 200
        venues = response.json()
        assert len(venues) == 2
        assert venues[1] == {
          'id': 2, 'name': 'Goodies', 'rank': 2, 'bg_color_hex': '2D8289'
        }
----

=== üß™1 : le bilan

ü§∑ ?

=== üß™1 : le bilan

* c'est lent
* code d'initialisation du contexte
* surcharger des variables d'environnement
** tests fragiles
** les lire √† chaque connexion est contre-intuitif
* tout le code de test doit √™tre dans le "with MySqlContainer() ..."

== üêí monkeypatch

* `fixture` : fonctionnalit√© ou donn√©es de test inject√©es par pytest

* `monkeypatch` : fixture permettant de modifier (le temps du cas de test) toute propri√©t√© d'un objet

* "_In Python, everything is an object_"

-> les d√©finitions d'un module peuvent √™tre modifi√©es √† chaud

[.notes]
--
Quand l'interpr√©teur python r√©soud un appel de fonction :
* il cherche le nom dans l'espace de nommage du module en cours
* l'espace de nommage est un `dict[str, Any]` ; on y trouve :
* les imports
* les d√©finitions du module (variables, fonctions, classes)

C'est pour √ßa :
* qu'il faut d√©clarer une fonction avant de pouvoir s'en servir
* que lorsque 2 d√©finitions ont le m√™me nom, la derni√®re √©crase la pr√©c√©dente
--

=== üêí monkeypatch

[.medium-text]
Dans `test_get_venues.py`, quelle d√©finition de module faut-il modifier ?

[source,text]
----
members_agenda_api/
 ‚îú‚îÄ services/
 ‚îÇ  ‚îú‚îÄ connection.py  # üçå def get_connection()
 ‚îÇ  ‚îú‚îÄ dataservice.py # class DataService
 ‚îÇ  ‚îî‚îÄ __init__.py    # üçå import get_connection, DataService ; def get_data_service()
 ‚îú‚îÄ api.py            # import get_data_service ; API_ROUTER = ...
 ‚îú‚îÄ __main__.py       # import API_ROUTER ; app = ...
 ‚îú‚îÄ ...
 ‚îú‚îÄ tests/
 ‚îÇ  ‚îú‚îÄ test_get_venues.py  # TestClient(app) ; üêí ?
 ...
----

=== üß™2 monkeypatch

[source,python]
----
from fastapi.testclient import TestClient
from pymysql.connections import Connection
from testcontainers.mysql import MySqlContainer

from members_agenda_api.__main__ import app

from tests.members_agenda_api.test_1_get_venues_envvars import create_2_test_venues

def test_get_2_venues_mkp(monkeypatch):
    with MySqlContainer() as container:
        connection = Connection(
            host=container.get_container_host_ip(),
            port=int(container.get_exposed_port(3306)),
            user=container.username, password=container.password,
            database=container.dbname,
        )
        create_2_test_venues(connection)

        monkeypatch.setattr(
            'members_agenda_api.services.get_connection', lambda: connection
        )

        client = TestClient(app)
        response = client.get('/api/venues')
        assert response.status_code == 200
        ...
----
=== üß™2 : le bilan

ü§∑ ?

=== üß™2 : le bilan

* ce qui est monkeypatch√© n'est pas test√©
* les modifications faites par monkeypatch durent le temps du cas de test
* cumul des d√©marrages de conteneurs üêå

== Bonnes pratiques

* localiser l'endroit o√π la connexion √† la base est faite -> facile √† monkeypatcher / mocker
* regrouper les interactions "natives" au service dans une classe (ou dans un module)
** tester la classe avec testcontainers
** mocker la classe dans les tests qui l'utilisent indirectement
* TestClient pour tester une API sans lancer le serveur web (voir https://fastapi.tiangolo.com/tutorial/testing/[testing FastAPI])

== Reste √† faire

* architecture d'une base de code
** code de prod
** code de test
** conftest
** fixture

C√¢blage :
** par variable d'environnements (peu intrusif ; /!\ si elles sont renomm√©es)
** monkeypatching (intrusion localis√©e - avec les bons outils)

markers pytest
* pouvoir labelliser des cas de tests (exclusion ou s√©lection)
* d√©s√©lection conditionnelle `skipif`

== Conclusions

* motivations & approches de test
* lancer un service conteneuris√© d√©di√© aux tests
* utiliser testcontainers au sein d'une session de tests pytest
* g√©n√©rer de la documentation fonctionnalit√©-architecture

[.columns]
== Merci üôè

[.column]
--
[.splashscreen-title]
Des questions ?

[.small-text]
Pr√©sentation √† retrouver sur https://github.com/lucsorel/conferences/tree/main/breizhcamp-2024.06.27-testcontainers-pytest[github.com/lucsorel/conferences/{...}/breizhcamp-2024.06.27-testcontainers-pytest] üìë
--

[.column.is-one-third]
--

.Vos retours sur https://openfeedback.io/LyIREj0UbxmZ6vcFmxmN/2024-06-27/670894[openfeedback.io/LyIREj0UbxmZ6vcFmxmN/2024-06-27/670894]
image::assets/openfeedback-testcontainers.svg[Vos retours sur openfeedback, 75%]
--


